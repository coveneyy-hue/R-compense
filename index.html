<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>R-compense</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111827; }
    header { padding: 14px 16px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 18px; }
    main { padding: 14px 16px 100px; max-width: 900px; margin: 0 auto; }

    .card { background:#fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color:#374151; margin-bottom: 6px; }

    select, input, button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 16px;
      box-sizing: border-box;
    }

    input[type="number"] { text-align: right; }
    button { cursor: pointer; border: 0; background:#111827; color:#fff; font-weight: 700; }
    button.secondary { background:#e5e7eb; color:#111827; border: 1px solid #d1d5db; }
    button.danger { background:#b91c1c; }

    .actions { display:flex; gap: 10px; flex-wrap: wrap; }
    .actions > * { flex: 1; min-width: 140px; }

    .muted { color:#6b7280; font-size: 13px; }
    .hint { font-size:12px; color:#6b7280; margin-top:6px; }

    .totals { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .totalBox { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; }
    .totalBox .name { font-weight: 800; }
    .totalBox .amt { font-size: 20px; font-weight: 900; margin-top: 4px; }
    .amt.pos { color:#065f46; }
    .amt.neg { color:#b91c1c; }

    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #f0f1f4; padding: 10px 6px; font-size: 14px; }
    th { text-align:left; color:#374151; font-size: 12px; }
    td.right, th.right { text-align:right; }

    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#f3f4f6; font-size: 12px; }
    .smallBtn { padding:8px 10px; border-radius:10px; font-size: 13px; }

    .badgeEdit {
      display:inline-block;
      margin-left: 8px;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background:#111827;
      color:#fff;
    }

    /* Barre enfant fixe */
    .kidBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(246,247,251,.95);
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      z-index: 9999;
    }
    .kidBtn{
      flex: 1;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-weight: 900;
    }
    .kidBtn.active{
      border-color: #111827;
      background: #111827;
      color: #ffffff;
    }
  </style>
</head>

<body>
<header><h1>R-compense</h1></header>

<main>
  <!-- Saisie -->
  <section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-weight:900;">
        Saisie
        <span id="editBadge" class="badgeEdit" style="display:none;">MODIFICATION</span>
      </div>
      <div class="muted" id="dbInfo"></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Date</label>
        <input id="dateInput" type="date" />
      </div>
      <div>
        <label>Catégorie</label>
        <select id="catSelect"></select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Montant</label>
        <input id="amtInput" type="number" step="0.01" />
      </div>
      <div>
        <label>Description (max 100)</label>
        <input id="descInput" type="text" maxlength="100" />
        <div class="hint"><span id="descCount">0</span>/100</div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;">
      <button id="saveBtn">Enregistrer</button>
      <button id="cancelEditBtn" class="secondary" style="display:none;">Annuler</button>
    </div>

    <div class="actions" style="margin-top:10px;">
      <button id="resetBtn" class="secondary">Réinitialiser</button>
      <button id="backupNowBtn" class="secondary">Backup auto</button>
    </div>

    <p class="muted" id="statusMsg"></p>
  </section>

  <!-- Totaux -->
  <section class="card">
    <div class="totals" id="totals"></div>
  </section>

  <!-- Détails -->
  <section class="card">
    <div style="display:flex; justify-content:space-between;">
      <strong>Détails</strong>
      <span class="muted" id="rowsCount"></span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Enfant</th>
          <th>Catégorie</th>
          <th>Description</th>
          <th class="right">Montant</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</main>

<!-- Barre enfant -->
<div class="kidBar">
  <button id="kidLily" class="kidBtn active">Lily-Rose</button>
  <button id="kidVictor" class="kidBtn">Victor</button>
</div>

<script>
/* ========= CONFIG SIMPLE ========= */
const KIDS = ["Lily-Rose","Victor"];
const CATS = ["École","Bon action","Défi","Cadeau","Dépense"];
let ACTIVE_CHILD = "Lily-Rose";

/* ========= HELPERS ========= */
const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().slice(0,10);
const money = n => (n<0?"-":"") + Math.abs(n).toFixed(2) + " $";

/* ========= DB ========= */
const DB = "rcompense";
let data = JSON.parse(localStorage.getItem(DB) || "[]");

/* ========= UI ========= */
function setActiveChild(name){
  ACTIVE_CHILD = name;
  $("kidLily").classList.toggle("active", name==="Lily-Rose");
  $("kidVictor").classList.toggle("active", name==="Victor");
  $("statusMsg").textContent = "Contexte : " + name;
}

function refresh(){
  localStorage.setItem(DB, JSON.stringify(data));
  $("dbInfo").textContent = data.length + " lignes";
  renderTotals();
  renderRows();
}

function renderTotals(){
  const t = { "Lily-Rose":0, "Victor":0 };
  data.forEach(r=>t[r.child]+=r.amount);
  $("totals").innerHTML = `
    <div class="totalBox"><div class="name">Lily-Rose</div><div class="amt ${t["Lily-Rose"]<0?"neg":"pos"}">${money(t["Lily-Rose"])}</div></div>
    <div class="totalBox"><div class="name">Victor</div><div class="amt ${t["Victor"]<0?"neg":"pos"}">${money(t["Victor"])}</div></div>`;
}

function renderRows(){
  $("rows").innerHTML = data.map((r,i)=>`
    <tr>
      <td>${r.date}</td>
      <td><span class="pill">${r.child}</span></td>
      <td>${r.cat}</td>
      <td>${r.desc}</td>
      <td class="right">${money(r.amount)}</td>
      <td class="right"><button class="danger smallBtn" onclick="del(${i})">Suppr.</button></td>
    </tr>`).join("");
  $("rowsCount").textContent = data.length+" lignes";
}

/* ========= ACTIONS ========= */
function save(){
  if(!$("amtInput").value || !$("descInput").value) return;
  data.push({
    child: ACTIVE_CHILD,
    date: $("dateInput").value || today(),
    cat: $("catSelect").value,
    amount: Number($("amtInput").value),
    desc: $("descInput").value
  });
  $("amtInput").value="";
  $("descInput").value="";
  refresh();
}

function del(i){ data.splice(i,1); refresh(); }

/* ========= INIT ========= */
$("dateInput").value = today();
CATS.forEach(c=>$("catSelect").innerHTML+=`<option>${c}</option>`);
$("saveBtn").onclick = save;
$("resetBtn").onclick = ()=>{$("amtInput").value="";$("descInput").value="";}
$("kidLily").onclick = ()=>setActiveChild("Lily-Rose");
$("kidVictor").onclick = ()=>setActiveChild("Victor");
$("descInput").oninput = ()=>$("descCount").textContent=$("descInput").value.length;
refresh();
</script>
</body>
</html>
