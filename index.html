<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>R-compense</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111827; }
    header { padding: 14px 16px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 18px; }
    main { padding: 14px 16px 120px; max-width: 980px; margin: 0 auto; }

    .card { background:#fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color:#374151; margin-bottom: 6px; }

    select, input, button, textarea {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #e5e7eb; font-size: 16px; background:#fff;
      box-sizing: border-box;
    }
    input[type="number"] { text-align: right; }
    button { cursor: pointer; border: 0; background:#111827; color:#fff; font-weight: 800; }
    button.secondary { background:#e5e7eb; color:#111827; border: 1px solid #d1d5db; }
    button.danger { background:#b91c1c; }
    .actions { display:flex; gap: 10px; flex-wrap: wrap; }
    .actions > * { flex: 1; min-width: 140px; }

    .muted { color:#6b7280; font-size: 13px; }
    .hint { font-size:12px; color:#6b7280; margin-top:6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .totals { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .totalBox { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; }
    .totalBox .name { font-weight: 900; }
    .totalBox .amt { font-size: 20px; font-weight: 1000; margin-top: 4px; }
    .amt.pos { color:#065f46; }
    .amt.neg { color:#b91c1c; }

    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #f0f1f4; padding: 10px 6px; font-size: 14px; vertical-align: top; }
    th { text-align:left; color:#374151; font-size: 12px; }
    td.right, th.right { text-align:right; }

    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#f3f4f6; font-size: 12px; color:#111827; }
    .smallBtn { padding:8px 10px; border-radius:10px; font-size: 13px; width:auto; }
    .badgeEdit { display:inline-block; margin-left: 8px; font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#111827; color:#fff; }

    .toolbar { display:flex; gap: 10px; align-items: end; flex-wrap: wrap; }
    .toolbar > div { flex: 1; min-width: 160px; }
    details summary { cursor: pointer; font-weight: 900; }

    textarea { min-height: 92px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }

    /* Barre enfant fixe */
    .kidBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(246,247,251,.92);
      border-top: 1px solid #e5e7eb;
      backdrop-filter: blur(6px);
      display: flex;
      gap: 10px;
      z-index: 9999;
    }
    .kidBtn{
      flex: 1;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-weight: 1000;
      padding: 12px 12px;
    }
    .kidBtn.active{
      border-color: #111827;
      background: #111827;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <header><h1>R-compense</h1></header>

  <main>
    <!-- Saisie -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:1000;">
          Saisie
          <span id="editBadge" class="badgeEdit" style="display:none;">MODE MODIFICATION</span>
        </div>
        <div class="muted" id="dbInfo"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div>
          <label>Catégorie</label>
          <select id="catSelect"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Montant (peut être négatif)</label>
          <input id="amtInput" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
        </div>
        <div>
          <label>Description (obligatoire, max 100 caractères)</label>
          <input id="descInput" type="text" maxlength="100" placeholder="Ex: lunch, défi, cadeau..." />
          <div class="hint"><span id="descCount">0</span>/100</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button id="saveBtn">Enregistrer</button>
        <button id="cancelEditBtn" class="secondary" type="button" style="display:none;">Annuler modif</button>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="resetBtn" class="secondary" type="button">Réinitialiser</button>
        <button id="backupNowBtn" class="secondary" type="button">Backup auto (JSON + CSV)</button>
      </div>

      <div style="margin-top:8px;" class="muted" id="backupInfo"></div>
      <p class="muted" id="statusMsg" style="margin:10px 0 0;"></p>
    </section>

    <!-- Totaux -->
    <section class="card">
      <div class="totals" id="totals"></div>
      <p class="muted" style="margin:10px 0 0;">Totaux calculés sur l’historique complet.</p>
    </section>

    <!-- Détails / Historique -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:1000;">Historique (transactions)</div>
        <div class="muted">
          <span id="rowsCount"></span> • Total filtre: <span id="filteredTotal" style="font-weight:1000;"></span>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <div>
          <label>Filtrer (enfant) — multi</label>
          <select id="filterChild" multiple size="3"></select>
          <div class="hint">Android: touche pour sélectionner, retouche pour désélectionner.</div>
        </div>

        <div>
          <label>Filtrer (catégorie) — multi</label>
          <select id="filterCat" multiple size="5"></select>
        </div>

        <div>
          <label>Description contient</label>
          <input id="filterDesc" type="text" placeholder="ex: lunch, défi..." />
        </div>

        <div>
          <label>Du</label>
          <input id="fromDate" type="date" />
        </div>

        <div>
          <label>Au</label>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="applyFilterBtn" class="secondary" type="button">Appliquer filtre</button>
        <button id="clearFilterBtn" class="secondary" type="button">Effacer filtre</button>
        <button id="exportBtn" class="secondary" type="button">Exporter JSON</button>
        <button id="importBtn" class="secondary" type="button">Importer JSON</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />

      <div style="overflow:auto; margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th><button class="secondary smallBtn" type="button" data-sort="date">Date</button></th>
              <th><button class="secondary smallBtn" type="button" data-sort="child">Enfant</button></th>
              <th><button class="secondary smallBtn" type="button" data-sort="category">Catégorie</button></th>
              <th><button class="secondary smallBtn" type="button" data-sort="desc">Description</button></th>
              <th class="right"><button class="secondary smallBtn" type="button" data-sort="amount">Montant</button></th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted" style="margin:10px 0 0;">Tri: touche l’en-tête (re-touche = inverse asc/desc).</p>
    </section>

    <!-- Journal -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:1000;">Journal (actions)</div>
        <div class="muted" id="logCount"></div>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="clearLogBtn" class="danger" type="button">Vider le journal</button>
        <button id="exportLogBtn" class="secondary" type="button">Exporter journal JSON</button>
      </div>

      <div style="overflow:auto; margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Action</th>
              <th>Détails</th>
              <th class="right">Montant</th>
            </tr>
          </thead>
          <tbody id="logRows"></tbody>
        </table>
      </div>
      <p class="muted" style="margin:10px 0 0;">Conserve : AJOUT / MODIF / SUPPR / PARAM / IMPORT / EXPORT / BACKUP.</p>
    </section>

    <!-- Paramètres -->
    <section class="card">
      <details>
        <summary>Paramètres (catégories, backup)</summary>

        <div style="margin-top:10px;">
          <label>Catégories (une par ligne)</label>
          <textarea id="catsCfg"></textarea>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button id="saveCfgBtn" class="secondary" type="button">Enregistrer catégories</button>
          <button id="resetCfgBtn" class="secondary" type="button">Remettre par défaut</button>
        </div>

        <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0;" />

        <div class="row">
          <div>
            <label>Rappel backup (jours)</label>
            <input id="backupDays" type="number" min="1" step="1" />
            <div class="hint">Ex: 7 = rappel si aucun backup depuis 7 jours.</div>
          </div>
          <div>
            <label>Dernier backup</label>
            <input id="lastBackupDisplay" type="text" disabled />
            <div class="hint">Mis à jour quand tu fais “Backup auto”.</div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button id="saveBackupCfgBtn" class="secondary" type="button">Enregistrer rappel</button>
          <button id="backupNowBtn2" class="secondary" type="button">Backup auto (JSON + CSV)</button>
        </div>
      </details>
    </section>
  </main>

  <!-- Barre enfant fixe -->
  <div class="kidBar" role="navigation" aria-label="Choix enfant">
    <button id="kidLily" class="kidBtn">Lily-Rose</button>
    <button id="kidVictor" class="kidBtn">Victor</button>
  </div>

<script>
/* =========================
   IndexedDB (persistance)
========================= */
const DB_NAME = "kids_budget_db";
const DB_VER  = 2;

const STORE_TX  = "tx";   // transactions
const STORE_CFG = "cfg";  // settings
const STORE_LOG = "log";  // journal

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;

      if (!db.objectStoreNames.contains(STORE_TX)) {
        const s = db.createObjectStore(STORE_TX, { keyPath: "id", autoIncrement: true });
        s.createIndex("byDate", "date");
        s.createIndex("byChild", "child");
        s.createIndex("byChildDate", ["child", "date"]);
      }

      if (!db.objectStoreNames.contains(STORE_CFG)) {
        db.createObjectStore(STORE_CFG, { keyPath: "key" });
      }

      if (!db.objectStoreNames.contains(STORE_LOG)) {
        const l = db.createObjectStore(STORE_LOG, { keyPath: "id", autoIncrement: true });
        l.createIndex("byTs", "ts");
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbTx(store, mode, fn) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(store, mode);
    const s = t.objectStore(store);
    let out;
    try { out = fn(s); } catch (e) { reject(e); return; }
    t.oncomplete = () => resolve(out);
    t.onerror = () => reject(t.error);
  });
}

async function dbPut(store, value) { return dbTx(store, "readwrite", (s) => s.put(value)); }
async function dbGet(store, key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(store, "readonly");
    const req = t.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}
async function dbGetAll(store) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(store, "readonly");
    const req = t.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}
async function dbAdd(store, obj) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(store, "readwrite");
    const req = t.objectStore(store).add(obj);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function dbDelete(store, id) { return dbTx(store, "readwrite", (s) => s.delete(id)); }
async function dbClear(store) { return dbTx(store, "readwrite", (s) => s.clear()); }

/* =========================
   Journal (actions)
========================= */
function nowISO() { return new Date().toISOString(); }
function fmtTs(ts) {
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}
async function logAction(action, amount, details) {
  const entry = {
    ts: Date.now(),
    action: String(action || ""),
    amount: Number.isFinite(Number(amount)) ? Number(amount) : 0,
    details: String(details || "")
  };
  await dbAdd(STORE_LOG, entry);
}

/* =========================
   UI helpers
========================= */
const $ = (id) => document.getElementById(id);

function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtMoney(n) {
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(n);
  return sign + abs.toFixed(2) + " $";
}
function setStatus(msg) { $("statusMsg").textContent = msg || ""; }
function normalizeLines(text) { return text.split("\n").map(s => s.trim()).filter(s => s.length > 0); }
function esc(s) {
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* =========================
   Config
========================= */
const FIXED_KIDS = ["Lily-Rose", "Victor"];
const DEFAULT_CATS = ["École", "Bon action", "Défi", "Cadeau", "Dépense"];

async function loadConfig() {
  const cfg = await dbGet(STORE_CFG, "settings");
  if (cfg?.value?.cats?.length) return cfg.value;

  const fresh = {
    kids: FIXED_KIDS,
    cats: DEFAULT_CATS,
    defaults: { kid: FIXED_KIDS[0], cat: DEFAULT_CATS[0] },
    backup: { intervalDays: 7, lastBackupTs: null }
  };
  await dbPut(STORE_CFG, { key:"settings", value:fresh });
  return fresh;
}
async function saveConfig(newCfg) { await dbPut(STORE_CFG, { key:"settings", value:newCfg }); }

/* =========================
   State
========================= */
let CFG = null;
let ALL_TX = [];
let ALL_LOG = [];

// Contexte enfant via boutons
let ACTIVE_CHILD = "Lily-Rose";

// Filtres (multi) + tri
let FILTER = { children: [], cats: [], desc: "", from: "", to: "" };
let SORT = { col: "date", dir: "desc" };

let EDIT_ID = null;

/* =========================
   Contexte enfant (boutons)
========================= */
function setActiveChild(name) {
  ACTIVE_CHILD = name;

  $("kidLily").classList.toggle("active", ACTIVE_CHILD === "Lily-Rose");
  $("kidVictor").classList.toggle("active", ACTIVE_CHILD === "Victor");
}

/* =========================
   Select helpers (multi)
========================= */
function getSelectedValues(selectEl) {
  return Array.from(selectEl.selectedOptions).map(o => o.value);
}
function setSelectedValues(selectEl, values) {
  const set = new Set(values || []);
  Array.from(selectEl.options).forEach(o => { o.selected = set.has(o.value); });
}
function renderSelectOptions(selectEl, items, selected) {
  selectEl.innerHTML = "";
  for (const it of items) {
    const opt = document.createElement("option");
    opt.value = it;
    opt.textContent = it;
    if (it === selected) opt.selected = true;
    selectEl.appendChild(opt);
  }
}

function renderFilterSelects() {
  // enfants multi
  const selChild = $("filterChild");
  selChild.innerHTML = "";
  for (const kid of CFG.kids) {
    const opt = document.createElement("option");
    opt.value = kid;
    opt.textContent = kid;
    selChild.appendChild(opt);
  }

  // catégories multi
  const selCat = $("filterCat");
  selCat.innerHTML = "";
  for (const c of CFG.cats) {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    selCat.appendChild(opt);
  }

  setSelectedValues(selChild, FILTER.children);
  setSelectedValues(selCat, FILTER.cats);
  $("filterDesc").value = FILTER.desc || "";
}

/* =========================
   Tri + filtre
========================= */
function compareRows(a, b, col, dir) {
  const sign = (dir === "asc") ? 1 : -1;

  if (col === "amount") {
    const na = Number(a.amount || 0);
    const nb = Number(b.amount || 0);
    return sign * (na - nb);
  }

  if (col === "date") {
    const sa = String(a.date || "");
    const sb = String(b.date || "");
    if (sa < sb) return sign * -1;
    if (sa > sb) return sign *  1;
    return sign * ((a.id||0) - (b.id||0));
  }

  if (col === "desc") {
    const sa = String(a.desc || "").toLowerCase();
    const sb = String(b.desc || "").toLowerCase();
    if (sa < sb) return sign * -1;
    if (sa > sb) return sign *  1;
    return sign * ((a.id||0) - (b.id||0));
  }

  if (col === "child") {
    const sa = String(a.child || "").toLowerCase();
    const sb = String(b.child || "").toLowerCase();
    if (sa < sb) return sign * -1;
    if (sa > sb) return sign *  1;
    return sign * ((a.id||0) - (b.id||0));
  }

  if (col === "category") {
    const sa = String(a.category || "").toLowerCase();
    const sb = String(b.category || "").toLowerCase();
    if (sa < sb) return sign * -1;
    if (sa > sb) return sign *  1;
    return sign * ((a.id||0) - (b.id||0));
  }

  return sign * ((a.id||0) - (b.id||0));
}

function applyFilter(txList) {
  const childrenSet = new Set(FILTER.children || []);
  const catsSet = new Set(FILTER.cats || []);
  const q = (FILTER.desc || "").trim().toLowerCase();

  let rows = [...txList];

  if (childrenSet.size > 0) rows = rows.filter(r => childrenSet.has(r.child));
  if (catsSet.size > 0) rows = rows.filter(r => catsSet.has(r.category));

  if (FILTER.from) rows = rows.filter(r => r.date >= FILTER.from);
  if (FILTER.to) rows = rows.filter(r => r.date <= FILTER.to);

  if (q) rows = rows.filter(r => String(r.desc || "").toLowerCase().includes(q));

  rows.sort((a,b) => compareRows(a,b,SORT.col,SORT.dir));
  return rows;
}

/* =========================
   Edit mode / counters
========================= */
function setEditMode(on, id=null) {
  EDIT_ID = on ? Number(id) : null;
  $("editBadge").style.display = on ? "inline-block" : "none";
  $("cancelEditBtn").style.display = on ? "inline-block" : "none";
  $("saveBtn").textContent = on ? "Enregistrer modification" : "Enregistrer";
}
function updateDescCounter() { $("descCount").textContent = String($("descInput").value.length); }

/* =========================
   Backup helpers
========================= */
function daysBetween(tsThen, tsNow) {
  const ms = Math.max(0, tsNow - tsThen);
  return ms / (1000 * 60 * 60 * 24);
}
function formatLastBackup(ts) {
  if (!ts) return "Jamais";
  return fmtTs(ts);
}
function isBackupStale() {
  const interval = Number(CFG?.backup?.intervalDays || 7);
  const last = CFG?.backup?.lastBackupTs;
  if (!last) return true;
  return daysBetween(Number(last), Date.now()) >= interval;
}
async function updateBackupUI() {
  const interval = Number(CFG?.backup?.intervalDays || 7);
  const last = CFG?.backup?.lastBackupTs;
  const info = `Backup: ${formatLastBackup(last)} • Rappel: ${interval} jour(s)` + (isBackupStale() ? " ⚠️" : "");
  $("backupInfo").textContent = info;

  $("backupDays").value = String(interval);
  $("lastBackupDisplay").value = formatLastBackup(last);
}
function maybeRemindBackup() {
  if (isBackupStale()) {
    const interval = Number(CFG?.backup?.intervalDays || 7);
    setStatus(`⚠️ Pense à faire un backup (aucun backup depuis ≥ ${interval} jour(s)).`);
  }
}
async function saveBackupReminderFromUI() {
  const v = Number($("backupDays").value);
  if (!Number.isFinite(v) || v < 1) return setStatus("Rappel backup invalide (min 1 jour).");

  CFG.backup = CFG.backup || { intervalDays: 7, lastBackupTs: null };
  CFG.backup.intervalDays = Math.floor(v);

  await saveConfig(CFG);
  await logAction("PARAM", 0, `Backup reminder = ${CFG.backup.intervalDays} jour(s)`);
  await refreshData();
  await updateBackupUI();
  setStatus("Rappel backup enregistré ✅");
}

/* =========================
   Backup auto (JSON + CSV)
========================= */
async function backupNow() {
  const tx = await dbGetAll(STORE_TX);
  const log = await dbGetAll(STORE_LOG);

  const payload = {
    version: 1,
    exportedAt: nowISO(),
    cfg: CFG,
    tx,
    log
  };

  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const hh = String(d.getHours()).padStart(2, "0");
  const mi = String(d.getMinutes()).padStart(2, "0");
  const ss = String(d.getSeconds()).padStart(2, "0");
  const stamp = `${yyyy}${mm}${dd}-${hh}${mi}${ss}`;

  const jsonName = `budget-enfants-${stamp}.json`;
  const csvName  = `budget-enfants-${stamp}.csv`;

  // Totaux
  const totals = { "Lily-Rose": 0, "Victor": 0 };
  for (const r of tx) {
    if (totals[r.child] === undefined) totals[r.child] = 0;
    totals[r.child] += Number(r.amount || 0);
  }
  const totalGlobal = Object.values(totals).reduce((a,b)=>a+b,0);

  // CSV (séparateur ;)
  const csvEscape = (v) => {
    const s = String(v ?? "");
    if (/[;"\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  };

  const txSorted = [...tx].sort((a,b) => (String(b.date||"").localeCompare(String(a.date||"")) || ((b.id||0)-(a.id||0))));

  const lines = [];
  lines.push(`# Export lisible - ${nowISO()}`);
  lines.push(`# Total Lily-Rose;${totals["Lily-Rose"].toFixed(2)}`);
  lines.push(`# Total Victor;${totals["Victor"].toFixed(2)}`);
  lines.push(`# Total global;${totalGlobal.toFixed(2)}`);
  lines.push(`#`);
  lines.push(`Date;Enfant;Catégorie;Montant;Description`);

  for (const r of txSorted) {
    lines.push([
      csvEscape(r.date),
      csvEscape(r.child),
      csvEscape(r.category),
      csvEscape(Number(r.amount || 0).toFixed(2)),
      csvEscape(r.desc || "")
    ].join(";"));
  }
  const csvText = lines.join("\n");

  const downloadBlob = (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  };

  downloadBlob(new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" }), jsonName);
  downloadBlob(new Blob([csvText], { type: "text/csv;charset=utf-8" }), csvName);

  CFG.backup = CFG.backup || { intervalDays: 7, lastBackupTs: null };
  CFG.backup.lastBackupTs = Date.now();
  await saveConfig(CFG);

  await logAction("BACKUP", 0, `Backup: ${jsonName} + ${csvName}`);
  await refreshData();
  await updateBackupUI();

  setStatus("Backup généré ✅ (JSON + CSV)");
}

/* =========================
   Render
========================= */
function renderTotals() {
  const totals = {};
  for (const kid of CFG.kids) totals[kid] = 0;

  for (const r of ALL_TX) {
    if (totals[r.child] === undefined) totals[r.child] = 0;
    totals[r.child] += Number(r.amount || 0);
  }

  const wrap = $("totals");
  wrap.innerHTML = "";
  for (const kid of CFG.kids) {
    const amt = totals[kid] || 0;
    const box = document.createElement("div");
    box.className = "totalBox";
    box.innerHTML = `
      <div class="name">${esc(kid)}</div>
      <div class="amt ${amt < 0 ? "neg" : "pos"}">${fmtMoney(amt)}</div>
    `;
    wrap.appendChild(box);
  }
}

function renderTable() {
  const tbody = $("rows");
  tbody.innerHTML = "";

  const rows = applyFilter(ALL_TX);
  $("rowsCount").textContent = `${rows.length} ligne(s) affichée(s)`;

  const sum = rows.reduce((acc, r) => acc + Number(r.amount || 0), 0);
  $("filteredTotal").textContent = fmtMoney(sum);

  if (rows.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" class="muted">Aucune ligne (selon le filtre).</td>`;
    tbody.appendChild(tr);
    return;
  }

  for (const r of rows) {
    const amtNum = Number(r.amount || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.date)}</td>
      <td><span class="pill">${esc(r.child)}</span></td>
      <td>${esc(r.category)}</td>
      <td>${esc(r.desc)}</td>
      <td class="right ${amtNum < 0 ? "neg" : "pos"}" style="font-weight:1000;">${fmtMoney(amtNum)}</td>
      <td class="right">
        <button class="secondary smallBtn" data-edit="${r.id}">Modifier</button>
        <button class="danger smallBtn" data-del="${r.id}">Suppr.</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("button[data-edit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.getAttribute("data-edit"));
      const r = ALL_TX.find(x => x.id === id);
      if (!r) return;

      // bascule contexte enfant automatiquement
      setActiveChild(r.child);

      $("dateInput").value = r.date;
      $("catSelect").value = r.category;
      $("amtInput").value = String(Number(r.amount).toFixed(2));
      $("descInput").value = r.desc || "";
      updateDescCounter();

      setEditMode(true, id);
      setStatus("Modification: ajuste les champs puis enregistre.");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  tbody.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = Number(btn.getAttribute("data-del"));
      const r = ALL_TX.find(x => x.id === id);
      if (!r) return;

      if (!confirm(`Supprimer cette ligne ?\n\n${r.date} • ${r.child} • ${r.category}\n${r.desc}\n${fmtMoney(Number(r.amount))}`)) return;

      await dbDelete(STORE_TX, id);
      await logAction("SUPPR", r.amount, `id=${id} | ${r.child} | ${r.date} | ${r.category} | ${r.desc}`);
      await refreshData();

      if (EDIT_ID === id) {
        setEditMode(false);
        resetEntryForm();
      }

      maybeRemindBackup();
      setStatus("Ligne supprimée ✅");
    });
  });
}

function renderLog() {
  const tbody = $("logRows");
  tbody.innerHTML = "";

  const logs = [...ALL_LOG].sort((a,b) => (b.ts - a.ts));
  $("logCount").textContent = `${logs.length} action(s)`;

  if (logs.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Aucune action.</td>`;
    tbody.appendChild(tr);
    return;
  }

  for (const l of logs.slice(0, 300)) {
    const amt = Number(l.amount || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${esc(fmtTs(l.ts))}</td>
      <td><span class="pill">${esc(l.action)}</span></td>
      <td>${esc(l.details)}</td>
      <td class="right ${amt < 0 ? "neg" : "pos"}" style="font-weight:1000;">${fmtMoney(amt)}</td>
    `;
    tbody.appendChild(tr);
  }

  if (logs.length > 300) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Affichage limité aux 300 dernières actions.</td>`;
    tbody.appendChild(tr);
  }
}

/* =========================
   Data refresh
========================= */
async function refreshData() {
  ALL_TX = await dbGetAll(STORE_TX);
  ALL_LOG = await dbGetAll(STORE_LOG);

  renderTotals();
  renderTable();
  renderLog();

  $("dbInfo").textContent = `Transactions: ${ALL_TX.length} • Journal: ${ALL_LOG.length}`;
  await updateBackupUI();
}

/* =========================
   Save / Update transaction
========================= */
function validateEntryFields() {
  const child = ACTIVE_CHILD;
  const date = $("dateInput").value || todayISO();
  const category = $("catSelect").value;
  const amtRaw = $("amtInput").value;
  const desc = $("descInput").value.trim();

  if (!child) return { ok:false, msg:"Choisis un enfant (boutons en bas)." };
  if (!date) return { ok:false, msg:"Choisis une date." };
  if (!category) return { ok:false, msg:"Choisis une catégorie." };
  if (amtRaw === "" || amtRaw === null) return { ok:false, msg:"Saisis un montant." };

  const amount = Number(amtRaw);
  if (!Number.isFinite(amount)) return { ok:false, msg:"Montant invalide." };

  if (!desc) return { ok:false, msg:"La description est obligatoire (max 100 caractères)." };
  if (desc.length > 100) return { ok:false, msg:"Description trop longue (max 100)." };

  return { ok:true, child, date, category, amount, desc };
}

async function saveOrUpdate() {
  const v = validateEntryFields();
  if (!v.ok) return setStatus(v.msg);

  if (EDIT_ID == null) {
    const id = await dbAdd(STORE_TX, {
      child: v.child,
      date: v.date,
      category: v.category,
      amount: v.amount,
      desc: v.desc,
      createdAt: Date.now(),
      updatedAt: null
    });
    await logAction("AJOUT", v.amount, `id=${id} | ${v.child} | ${v.date} | ${v.category} | ${v.desc}`);
    await refreshData();

    $("amtInput").value = "";
    $("descInput").value = "";
    updateDescCounter();

    setStatus("Enregistré ✅");
    maybeRemindBackup();
    return;
  }

  const id = Number(EDIT_ID);
  const old = ALL_TX.find(x => x.id === id);
  if (!old) {
    setEditMode(false);
    return setStatus("La ligne à modifier n’existe plus.");
  }

  const updated = {
    ...old,
    child: v.child,
    date: v.date,
    category: v.category,
    amount: v.amount,
    desc: v.desc,
    updatedAt: Date.now()
  };
  await dbPut(STORE_TX, updated);

  const delta = Number(updated.amount) - Number(old.amount || 0);
  await logAction(
    "MODIF",
    updated.amount,
    `id=${id} | ancien=${fmtMoney(Number(old.amount||0))} | nouveau=${fmtMoney(updated.amount)} | delta=${fmtMoney(delta)} | ${updated.child} | ${updated.date} | ${updated.category} | ${updated.desc}`
  );

  setEditMode(false);
  await refreshData();
  resetEntryForm();

  setStatus("Modification enregistrée ✅");
  maybeRemindBackup();
}

/* =========================
   Reset / cancel edit
========================= */
function resetEntryForm() {
  $("dateInput").value = todayISO();
  $("catSelect").value = CFG.defaults.cat || CFG.cats[0];
  $("amtInput").value = "";
  $("descInput").value = "";
  updateDescCounter();
  setStatus("");
}
function cancelEdit() {
  setEditMode(false);
  resetEntryForm();
  setStatus("Modification annulée.");
}

/* =========================
   Settings + Import/Export
========================= */
async function loadSettingsUI() {
  $("catsCfg").value = CFG.cats.join("\n");
}

async function saveSettingsFromUI() {
  const cats = normalizeLines($("catsCfg").value);
  if (cats.length === 0) return setStatus("Ajoute au moins 1 catégorie.");

  const defaults = {
    kid: FIXED_KIDS[0],
    cat: cats.includes(CFG.defaults?.cat) ? CFG.defaults.cat : cats[0],
  };

  const backup = CFG.backup || { intervalDays: 7, lastBackupTs: null };

  CFG = { kids: FIXED_KIDS, cats, defaults, backup };
  await saveConfig(CFG);

  renderSelectOptions($("catSelect"), CFG.cats, defaults.cat);
  renderFilterSelects();

  await logAction("PARAM", 0, `Catégories=${cats.join(", ")}`);
  await refreshData();
  setStatus("Catégories enregistrées ✅");
}

async function resetSettingsToDefault() {
  CFG = {
    kids: FIXED_KIDS,
    cats: DEFAULT_CATS,
    defaults: { kid: FIXED_KIDS[0], cat: DEFAULT_CATS[0] },
    backup: CFG?.backup || { intervalDays: 7, lastBackupTs: null }
  };
  await saveConfig(CFG);
  await logAction("PARAM", 0, "Paramètres remis par défaut");
  await initUIAfterConfig();
  setStatus("Paramètres remis par défaut ✅");
}

async function exportJSON() {
  const payload = {
    version: 1,
    exportedAt: nowISO(),
    cfg: CFG,
    tx: await dbGetAll(STORE_TX),
    log: await dbGetAll(STORE_LOG)
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `budget-enfants-${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  await logAction("EXPORT", 0, "Export JSON complet (transactions + journal)");
  await refreshData();
  setStatus("Export prêt ✅");
}

async function exportLogOnly() {
  const payload = { exportedAt: nowISO(), log: await dbGetAll(STORE_LOG) };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `journal-budget-${todayISO()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  setStatus("Export journal prêt ✅");
}

async function importJSON(file) {
  const text = await file.text();
  let payload;
  try { payload = JSON.parse(text); } catch { return setStatus("Fichier JSON invalide."); }
  if (!payload || !Array.isArray(payload.tx) || !payload.cfg) return setStatus("JSON non reconnu.");

  // On force les enfants aux 2 boutons
  CFG = payload.cfg;
  CFG.kids = FIXED_KIDS;
  CFG.cats = Array.isArray(CFG.cats) && CFG.cats.length ? CFG.cats : DEFAULT_CATS;
  CFG.defaults = CFG.defaults || { kid: FIXED_KIDS[0], cat: CFG.cats[0] };
  CFG.defaults.kid = FIXED_KIDS[0];
  if (!CFG.cats.includes(CFG.defaults.cat)) CFG.defaults.cat = CFG.cats[0];

  CFG.backup = CFG.backup || { intervalDays: 7, lastBackupTs: null };
  if (!Number.isFinite(Number(CFG.backup.intervalDays)) || Number(CFG.backup.intervalDays) < 1) CFG.backup.intervalDays = 7;
  if (CFG.backup.lastBackupTs !== null && !Number.isFinite(Number(CFG.backup.lastBackupTs))) CFG.backup.lastBackupTs = null;

  await saveConfig(CFG);

  await dbClear(STORE_TX);
  await dbClear(STORE_LOG);

  for (const r of payload.tx) {
    const safe = {
      child: FIXED_KIDS.includes(String(r.child)) ? String(r.child) : FIXED_KIDS[0],
      date: String(r.date || ""),
      category: String(r.category || ""),
      amount: Number(r.amount || 0),
      desc: String(r.desc || "").slice(0,100),
      createdAt: Number(r.createdAt || Date.now()),
      updatedAt: r.updatedAt ? Number(r.updatedAt) : null
    };
    if (!safe.date || !safe.category || !Number.isFinite(safe.amount) || !safe.desc) continue;
    await dbAdd(STORE_TX, safe);
  }

  if (Array.isArray(payload.log)) {
    for (const l of payload.log) {
      const safeL = {
        ts: Number(l.ts || Date.now()),
        action: String(l.action || "IMPORT"),
        amount: Number(l.amount || 0),
        details: String(l.details || "")
      };
      await dbAdd(STORE_LOG, safeL);
    }
  }

  await logAction("IMPORT", 0, "Import JSON complet (transactions + journal)");
  await initUIAfterConfig();
  setStatus("Import terminé ✅");
}

/* =========================
   Log actions UI
========================= */
async function clearLog() {
  if (!confirm("Vider le journal des actions ?")) return;
  await dbClear(STORE_LOG);
  await refreshData();
  setStatus("Journal vidé ✅");
}

/* =========================
   Init
========================= */
async function initUIAfterConfig() {
  $("dateInput").value = todayISO();

  renderSelectOptions($("catSelect"), CFG.cats, CFG.defaults.cat || CFG.cats[0]);

  FILTER = { children: [], cats: [], desc: "", from: "", to: "" };
  renderFilterSelects();
  $("fromDate").value = "";
  $("toDate").value = "";
  $("filterDesc").value = "";

  await loadSettingsUI();
  await refreshData();

  setEditMode(false);
  updateDescCounter();

  await updateBackupUI();
  maybeRemindBackup();

  // contexte initial
  setActiveChild(CFG.defaults.kid || "Lily-Rose");
}

async function init() {
  // PWA
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }

  CFG = await loadConfig();

  // sécurité
  CFG.kids = FIXED_KIDS;
  CFG.defaults = CFG.defaults || { kid: FIXED_KIDS[0], cat: CFG.cats?.[0] || DEFAULT_CATS[0] };
  CFG.defaults.kid = FIXED_KIDS[0];
  CFG.backup = CFG.backup || { intervalDays: 7, lastBackupTs: null };
  if (!Number.isFinite(Number(CFG.backup.intervalDays)) || Number(CFG.backup.intervalDays) < 1) CFG.backup.intervalDays = 7;
  if (CFG.backup.lastBackupTs !== null && !Number.isFinite(Number(CFG.backup.lastBackupTs))) CFG.backup.lastBackupTs = null;

  await initUIAfterConfig();
  resetEntryForm();

  // actions saisie
  $("saveBtn").addEventListener("click", saveOrUpdate);
  $("resetBtn").addEventListener("click", () => { setEditMode(false); resetEntryForm(); });
  $("cancelEditBtn").addEventListener("click", cancelEdit);
  $("descInput").addEventListener("input", updateDescCounter);

  $("backupNowBtn").addEventListener("click", backupNow);
  $("backupNowBtn2").addEventListener("click", backupNow);
  $("saveBackupCfgBtn").addEventListener("click", saveBackupReminderFromUI);

  // boutons enfant
  $("kidLily").addEventListener("click", () => setActiveChild("Lily-Rose"));
  $("kidVictor").addEventListener("click", () => setActiveChild("Victor"));

  // filtres
  $("applyFilterBtn").addEventListener("click", () => {
    FILTER.children = getSelectedValues($("filterChild"));
    FILTER.cats = getSelectedValues($("filterCat"));
    FILTER.desc = $("filterDesc").value || "";
    FILTER.from = $("fromDate").value || "";
    FILTER.to = $("toDate").value || "";
    renderTable();
  });

  $("clearFilterBtn").addEventListener("click", () => {
    FILTER = { children: [], cats: [], desc: "", from: "", to: "" };

    setSelectedValues($("filterChild"), []);
    setSelectedValues($("filterCat"), []);
    $("filterDesc").value = "";
    $("fromDate").value = "";
    $("toDate").value = "";

    renderTable();
  });

  // export/import
  $("exportBtn").addEventListener("click", exportJSON);
  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    await importJSON(f);
    e.target.value = "";
  });

  // journal
  $("clearLogBtn").addEventListener("click", clearLog);
  $("exportLogBtn").addEventListener("click", exportLogOnly);

  // paramètres
  $("saveCfgBtn").addEventListener("click", saveSettingsFromUI);
  $("resetCfgBtn").addEventListener("click", resetSettingsToDefault);

  // tri
  document.querySelectorAll('button[data-sort]').forEach(btn => {
    btn.addEventListener("click", () => {
      const col = btn.getAttribute("data-sort");
      if (SORT.col === col) {
        SORT.dir = (SORT.dir === "asc") ? "desc" : "asc";
      } else {
        SORT.col = col;
        SORT.dir = "asc";
        if (col === "date") SORT.dir = "desc"; // plus récent d'abord
      }
      renderTable();
    });
  });

  // enter = save
  $("amtInput").addEventListener("keydown", (e) => { if (e.key === "Enter") saveOrUpdate(); });
  $("descInput").addEventListener("keydown", (e) => { if (e.key === "Enter") saveOrUpdate(); });
}

init();
</script>
</body>
</html>
